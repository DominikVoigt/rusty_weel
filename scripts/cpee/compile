CDIR=$(dirname "$0")
echo "Compiling rust instance..."
INSTANCE_DIR=$1
INSTANCE_ID=$(basename $INSTANCE_DIR)

# copy source code over
ln -sf "$CDIR/rusty_weel/http_helper" $INSTANCE_DIR
ln -sf "$CDIR/rusty_weel/weel_lib" $INSTANCE_DIR
ln -sf "$CDIR/rusty_weel/weel_inject" $INSTANCE_DIR
ln -sf "$CDIR/rusty_weel/Cargo.toml" $INSTANCE_DIR
ln -sf "$CDIR/rusty_weel/Cargo.lock" $INSTANCE_DIR


cp -rf "$CDIR/rusty_weel/weel_bin" $INSTANCE_DIR

# Link build dir directly into instance dir
ln -s "$CDIR/target" "$INSTANCE_DIR"

# copy and run build script (will crate instance binary
ln -s "$CDIR/build" $INSTANCE_DIR
cd $INSTANCE_DIR
./build $INSTANCE_ID

# Dynlink the run script

cp -f "$CDIR/run" $INSTANCE_DIR
cp -f "$CDIR/run_heaptrack" $INSTANCE_DIR
cp -f "$CDIR/run_massif" $INSTANCE_DIR

